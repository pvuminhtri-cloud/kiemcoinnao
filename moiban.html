<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mời Bạn - 3D Glassmorphism Dashboard</title>
    <meta name="description" content="3D Glassmorphism Dashboard Template by TemplateMo">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@300;400;500;600;700&family=Space+Mono:wght@400;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="templatemo-glass-admin-style.css">

</head>

<body>
    <!-- Animated Background -->
    <div class="background"></div>
    <div class="orb orb-1"></div>
    <div class="orb orb-2"></div>
    <div class="orb orb-3"></div>

    <div class="dashboard">
        <!-- Sidebar Container -->
        <aside class="sidebar" id="sidebar"></aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Top Navbar -->
            <nav class="navbar">
                <div class="page-header">
                </div>
                <div class="navbar-right">
                    <button class="nav-btn" id="theme-toggle" title="Toggle Light/Dark Mode">
                        <svg class="icon-sun" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="4" />
                            <path d="M12 2v2" />
                            <path d="M12 20v2" />
                            <path d="M4.93 4.93l1.41 1.41" />
                            <path d="M17.66 17.66l1.41 1.41" />
                            <path d="M2 12h2" />
                            <path d="M20 12h2" />
                            <path d="M6.34 17.66l-1.41 1.41" />
                            <path d="M19.07 4.93l-1.41 1.41" />
                        </svg>
                        <svg class="icon-moon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                            style="display: none;">
                            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z" />
                        </svg>
                    </button>
                </div>
            </nav>

            <!-- Referral Page Content -->
            <section class="referral-container">
                <!-- Stats Grid -->
                <div class="withdraw-stats-grid">
                    <div class="referral-banner">
                        <div class="referral-icon-box">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2" />
                                <circle cx="9" cy="7" r="4" />
                                <path d="M23 21v-2a4 4 0 0 0-3-3.87" />
                                <path d="M16 3.13a4 4 0 0 1 0 7.75" />
                            </svg>
                        </div>
                        <div class="referral-stats">
                            <h2>Số bạn đã mời</h2>
                            <div class="count" id="total-referrals">0</div>
                        </div>
                    </div>


                </div>

                <div class="referral-description">
                    Chia sẻ liên kết và giới thiệu bạn bè đăng ký tài khoản. Bạn sẽ nhận được <strong>10% hoa
                        hồng</strong> cho mỗi nhiệm vụ người được giới thiệu hoàn thành.
                </div>

                <div class="referral-warning">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12 2L1 21h22L12 2zm0 3.99L19.53 19H4.47L12 5.99zM11 16h2v2h-2zm0-7h2v5h-2z" />
                    </svg>
                    Tạo tài khoản ảo giới thiệu sẽ bị khóa tài khoản vĩnh viễn
                </div>

                <div class="copy-section">
                    <input type="text" id="referral-link-input" class="link-input" value="Đang tải..." readonly>
                    <button class="copy-btn" id="copy-link-btn">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <rect x="9" y="9" width="13" height="13" rx="2" ry="2" />
                            <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1" />
                        </svg>
                        Sao chép
                    </button>
                </div>


            </section>


            <!-- Mobile Menu Toggle -->
            <button class="mobile-menu-toggle">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="3" y1="12" x2="21" y2="12" />
                    <line x1="3" y1="6" x2="21" y2="6" />
                    <line x1="3" y1="18" x2="21" y2="18" />
                </svg>
            </button>


            <!-- Footer -->
            <footer class="site-footer"></footer>

        </main>
    </div>

    <div id="notificationToast" class="notification-toast"></div>

    <script src="components.js"></script>
    <script src="api.js"></script>
    <script src="templatemo-glass-admin-script.js"></script>
    <script>
        // Load referral data on page load
        document.addEventListener('DOMContentLoaded', async () => {
            // Check authentication - support both JWT and old localStorage method
            const authToken = localStorage.getItem('authToken');
            const currentUser = localStorage.getItem('currentUser');

            if (!authToken && !currentUser) {
                window.location.href = 'login.html';
                return;
            }

            try {
                // Fetch referral stats
                const statsResponse = await fetch('/api/referrals/stats', {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                const statsData = await statsResponse.json();

                if (statsData.success) {
                    document.getElementById('referral-code').textContent = statsData.data.referralCode;
                    document.getElementById('total-referrals').textContent = statsData.data.totalReferrals;
                    document.getElementById('total-commission').textContent = statsData.data.totalCommission.toLocaleString() + ' Coin';

                    // Set referral link
                    const referralLink = `https://kiemcoinnao.xyz/register.html?ref=${statsData.data.referralCode}`;
                    document.getElementById('referral-link-input').value = referralLink;
                }

                // Fetch referred users list
                const listResponse = await fetch('/api/referrals/list', {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                const listData = await listResponse.json();

                if (listData.success && listData.data.length > 0) {
                    const tbody = document.getElementById('referred-users-body');
                    tbody.innerHTML = '';
                    listData.data.forEach(user => {
                        const date = new Date(user.createdAt);
                        const dateStr = date.toLocaleDateString('vi-VN');
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td>${user.username}</td>
                            <td>${user.email || 'N/A'}</td>
                            <td>${(user.balance || 0).toLocaleString()} Coin</td>
                            <td>${dateStr}</td>
                        `;
                        tbody.appendChild(tr);
                    });
                }

                // Fetch commission history
                const earningsResponse = await fetch('/api/referrals/earnings', {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                const earningsData = await earningsResponse.json();

                if (earningsData.success && earningsData.data.length > 0) {
                    const tbody = document.getElementById('commission-history-body');
                    tbody.innerHTML = '';
                    earningsData.data.forEach(earning => {
                        const date = new Date(earning.created_at);
                        const dateStr = date.toLocaleDateString('vi-VN') + ' ' + date.toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' });
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td>${dateStr}</td>
                            <td>${earning.referred_username}</td>
                            <td>${earning.task_name || 'N/A'}</td>
                            <td>${(earning.task_reward || 0).toLocaleString()} Coin</td>
                            <td style="color: var(--gold); font-weight: 600;">+${(earning.commission || 0).toLocaleString()} Coin</td>
                        `;
                        tbody.appendChild(tr);
                    });
                }

            } catch (error) {
                console.error('Error loading referral data:', error);
            }
        });

        // Copy link functionality
        document.getElementById('copy-link-btn').addEventListener('click', function () {
            const input = document.getElementById('referral-link-input');
            input.select();
            input.setSelectionRange(0, 99999); // For mobile devices

            try {
                document.execCommand('copy');
                const toast = document.getElementById('notificationToast');
                toast.textContent = 'Đã sao chép link giới thiệu!';
                toast.className = 'notification-toast success';
                setTimeout(() => toast.classList.add('show'), 10);
                setTimeout(() => toast.classList.remove('show'), 3000);
            } catch (err) {
                alert('Không thể sao chép. Vui lòng copy thủ công.');
            }
        });
    </script>
</body>

</html>